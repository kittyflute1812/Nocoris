name: Flutter CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  analyze:
    name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: flutter pub get

      - name: ã‚³ãƒ¼ãƒ‰è§£æžã‚’å®Ÿè¡Œ
        run: flutter analyze

      - name: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
        run: dart format --set-exit-if-changed .

      - name: è§£æžçµæžœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: analyze-results
          path: |
            **/*.dart
            analysis_options.yaml

  test:
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: flutter pub get

      - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: flutter test --coverage

      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          verbose: true

      - name: ãƒ†ã‚¹ãƒˆçµæžœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage/
            test/

  build-android:
    name: Androidãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    needs: [analyze, test]

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Javaç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: flutter pub get

      - name: APKã‚’ãƒ“ãƒ«ãƒ‰
        run: flutter build apk --release

      - name: APKã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  build-ios:
    name: iOSãƒ“ãƒ«ãƒ‰
    runs-on: macos-latest
    needs: [analyze, test]

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: flutter pub get

      - name: Podã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd ios
          pod install

      - name: iOSã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆç½²åãªã—ï¼‰
        run: flutter build ios --release --no-codesign

      - name: ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/

  lint-summary:
    name: Lintçµæžœã‚µãƒžãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [analyze, test]
    if: always()

    steps:
      - name: ã‚µãƒžãƒªãƒ¼ã‚’ä½œæˆ
        run: |
          echo "## ðŸŽ¯ CI/CDå®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… å®Œäº†ã—ãŸã‚¸ãƒ§ãƒ–" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š å“è³ªåŸºæº–" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… flutter analyze: è­¦å‘Šã‚¼ãƒ­" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… dart format: ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… flutter test: å…¨ãƒ†ã‚¹ãƒˆé€šéŽ" >> $GITHUB_STEP_SUMMARY
