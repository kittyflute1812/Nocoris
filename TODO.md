# CountDrop - 開発TODO

## 📋 プロジェクト概要

iPhoneユーザー向けの残数管理アプリケーション。アイテムの数量を簡単に管理し、ウィジェットからも操作可能。

## 🎯 技術スタック

- **開発言語**: Flutter/Dart
- **ストレージ**: ローカルストレージ（shared_preferences）
- **対象プラットフォーム**: iOS（iPhone）、macOS（開発用）
- **テストフレームワーク**: flutter_test、mocktail

---

## ✅ 完了した機能

### 1. アイテム管理基本機能
- [x] アイテムのCRUD操作の実装
  - [x] アイテム作成機能（名前、初期値の設定）
  - [x] アイテム一覧表示機能
  - [x] アイテム値の更新機能
  - [x] アイテム削除機能
  - [x] アイテムのインクリメント/デクリメント機能

**実装詳細**:
- `Item` モデル: ID、名前、カウント、作成日時、更新日時を管理
- `ItemService`: ビジネスロジックを集約（CRUD、カウント操作）
- UUID v4によるユニークID生成

### 2. データ永続化
- [x] ローカルストレージの実装
  - [x] shared_preferencesの導入
  - [x] アイテムデータの保存処理
  - [x] アイテムデータの読み込み処理
  - [x] JSON シリアライゼーション/デシリアライゼーション

**実装詳細**:
- `StorageService`: shared_preferencesの抽象化層
- すべての変更操作後に自動保存
- エラーハンドリング実装済み

### 3. UI/UX実装
- [x] メイン画面の実装（HomeScreen）
  - [x] アイテム一覧表示UI
  - [x] アイテム追加ボタン（FloatingActionButton）
  - [x] 各アイテムの減算/加算ボタン
  - [x] アイテム編集/削除機能へのアクセス
  - [x] 空状態の表示（アイテムがない場合）
  - [x] ローディング状態の表示
  - [x] エラーハンドリングとユーザーフィードバック（SnackBar）

- [x] アイテム作成/編集画面の実装（ItemFormScreen）
  - [x] アイテム名入力フォーム
  - [x] 数値入力フォーム
  - [x] 保存/キャンセルボタン
  - [x] バリデーション（必須入力チェック、数値検証）
  - [x] エラーハンドリング

- [x] 再利用可能なウィジェット
  - [x] ItemCard: アイテム表示カード

- [x] テーマ実装
  - [x] ライトモード
  - [x] ダークモード
  - [x] システム設定に応じた自動切り替え

**実装詳細**:
- Material Design準拠
- レスポンシブデザイン
- アクセシビリティ対応

### 4. テストとデバッグ
- [x] 単体テストの実装
  - [x] モデルのテスト（item_test.dart）
  - [x] ストレージ処理のテスト（storage_service_test.dart）
  - [x] ビジネスロジックのテスト（item_service_test.dart）

- [x] ウィジェットテスト
  - [x] HomeScreenのテスト（home_screen_test.dart）
  - [x] ItemFormScreenのテスト（item_form_screen_test.dart）
  - [x] ItemCardのテスト（item_card_test.dart）
  - [x] 基本的な操作フローのテスト
  - [x] エッジケースのテスト

- [x] テストヘルパー
  - [x] モックサービスの作成（test_helpers.dart）
  - [x] テストユーティリティ関数

**テスト状況**:
- 総テスト数: 39
- 合格率: 100%
- カバレッジ: 主要機能をカバー

### 5. エラーハンドリング
- [x] 非同期処理のエラーハンドリング
  - [x] ItemService初期化失敗時の処理
  - [x] データ保存失敗時の処理
  - [x] データ読み込み失敗時の処理

- [x] ユーザーフィードバック
  - [x] エラーメッセージの表示（SnackBar）
  - [x] 成功メッセージの表示
  - [x] ローディング状態の表示

- [x] BuildContext の適切な使用
  - [x] `use_build_context_synchronously` 警告の解消
  - [x] `mounted` チェックの実装

---

## 🚧 開発中・予定の機能

### 6. 状態管理の改善（.cursorrulesより）
- [ ] より適切な状態管理ソリューションの導入
  - [ ] Provider/Riverpodの導入検討
  - [ ] 状態管理パターンの選定（BLoC/Provider/Riverpod）
  - [ ] グローバル状態の最小化
  - [ ] 状態とUIコンポーネントの分離強化
  - [ ] 不変データ構造の徹底

**技術要件**:
- Provider/Riverpod パッケージ
- 状態管理アーキテクチャの設計
- 既存コードのリファクタリング

**実装の流れ**:
1. 状態管理ソリューションの選定（Provider推奨）
2. 依存性注入の実装
3. ItemServiceのProvider化
4. 画面ごとの状態管理の実装
5. テストの更新

**優先度**: 中（アプリが複雑になる前に導入推奨）

### 7. ナビゲーションの型安全化（.cursorrulesより）
- [ ] 型安全なナビゲーションの実装
  - [ ] go_router または auto_route の導入
  - [ ] ルート定義の集約
  - [ ] ディープリンク対応
  - [ ] ナビゲーションガードの実装

**技術要件**:
- go_router または auto_route パッケージ
- ルート設定ファイル

**優先度**: 中

### 8. iOSホーム画面ウィジェット機能
- [ ] WidgetKit を使用したホーム画面ウィジェットの実装
  - [ ] WidgetKit Extension の作成（Swift）
  - [ ] Timeline Provider の実装
  - [ ] ウィジェットレイアウトの設計（小・中・大サイズ対応）
  - [ ] アイテム選択機能（どのアイテムをウィジェットに表示するか）
  - [ ] ウィジェットでの残数表示
  - [ ] ウィジェットからの減算ボタン（App Intent使用）
  - [ ] App Groups によるデータ共有設定
  - [ ] ウィジェットの更新タイミング制御
  - [ ] ロック画面ウィジェット対応（iOS 16+）

**技術要件**:
- WidgetKit (iOS 14+)
- SwiftUI（ウィジェットUI）
- App Groups（メインアプリとウィジェット間のデータ共有）
- App Intents（ウィジェットからのインタラクション、iOS 16+）
- Timeline Provider（ウィジェットの更新管理）

**実装の流れ**:
1. Xcode でWidget Extension ターゲットを追加
2. App Groups を設定してデータ共有を有効化
3. Flutter側でApp Groups対応のストレージ実装
4. Swift/SwiftUIでウィジェットUIを実装
5. Timeline Providerでデータ更新を管理
6. App Intentsでボタンアクションを実装

**優先度**: 高

### 9. パフォーマンス最適化（.cursorrulesより）
- [ ] ウィジェット最適化
  - [ ] constコンストラクタの活用拡大
  - [ ] ValueKeyの適切な使用
  - [ ] RepaintBoundaryの導入検討
  - [ ] 不要な再構築の削減

- [ ] メモリ管理
  - [ ] メモリプロファイリングの実施
  - [ ] メモリリークの確認と修正
  - [ ] グローバル変数の最小化

- [ ] レンダリング最適化
  - [ ] Flutter Performance Overlayでの分析
  - [ ] ウィジェットツリーの簡素化
  - [ ] 画像の最適化（将来的に画像を使用する場合）

- [ ] バンドルサイズ最適化
  - [ ] 未使用コードの削除
  - [ ] コードの難読化設定
  - [ ] ABI分割ビルドの設定

- [ ] 大量データ対応
  - [ ] ListView.builderの最適化確認
  - [ ] ページネーション/無限スクロールの検討
  - [ ] データの遅延読み込み戦略

**優先度**: 中（アイテム数が増えた際に重要）

### 10. テストカバレッジの拡充（.cursorrulesより）
- [ ] 統合テストの追加
  - [ ] 画面間の相互作用テスト
  - [ ] データフローの統合テスト
  - [ ] エラーハンドリングの統合テスト

- [ ] エンドツーエンドテスト
  - [ ] ユーザーシナリオのE2Eテスト
  - [ ] クリティカルパスのテスト
  - [ ] パフォーマンステスト

- [ ] テストカバレッジの向上
  - [ ] カバレッジレポートの生成
  - [ ] 未カバー領域の特定と追加テスト
  - [ ] エッジケースのテスト強化

**優先度**: 中

### 11. エラーハンドリングの強化（.cursorrulesより）
- [ ] カスタムエラークラスの実装
  - [ ] エラータイプの分類
  - [ ] エラーコードの定義
  - [ ] エラーメッセージの統一

- [ ] ロギング機能の強化
  - [ ] エラーログの記録
  - [ ] デバッグログの実装
  - [ ] ログレベルの管理

- [ ] エラー画面の改善
  - [ ] カスタムErrorWidgetの実装
  - [ ] エラーリカバリー機能
  - [ ] ユーザーフレンドリーなエラー表示

**優先度**: 中

### 12. セキュリティ対策（.cursorrulesより）
- [ ] データ保護
  - [ ] 機密データの暗号化（将来的に必要な場合）
  - [ ] Keychain/Keystoreの活用検討
  - [ ] セキュアストレージの実装

- [ ] 入力検証の強化
  - [ ] サニタイゼーション処理の追加
  - [ ] バリデーションルールの強化
  - [ ] XSS対策（Webプラットフォーム対応時）

**優先度**: 低（現状は個人データのみ）

### 13. 国際化対応（.cursorrulesより）
- [ ] 多言語対応
  - [ ] flutter_localizationの導入
  - [ ] 言語リソースファイルの作成
  - [ ] 動的言語切り替え機能
  - [ ] 日付・数値のローカライゼーション

- [ ] アクセシビリティ向上
  - [ ] スクリーンリーダー対応の強化
  - [ ] セマンティックラベルの充実
  - [ ] フォントサイズの動的調整
  - [ ] コントラスト比の確認

**優先度**: 低（グローバル展開時に必要）

### 14. CI/CD環境の構築（.cursorrulesより）
- [ ] 自動化パイプラインの構築
  - [ ] GitHub Actionsの設定
  - [ ] 自動テスト実行
  - [ ] 自動リンティング/フォーマット
  - [ ] 自動ビルド

- [ ] デプロイ自動化
  - [ ] TestFlightへの自動デプロイ
  - [ ] App Storeへのリリース自動化
  - [ ] バージョン管理の自動化

- [ ] コード品質管理
  - [ ] カバレッジレポートの自動生成
  - [ ] 静的解析の自動実行
  - [ ] コードレビューの自動化支援

**優先度**: 中（開発効率向上のため）

### 15. デバッグ・モニタリング機能（.cursorrulesより）
- [ ] 開発ツールの活用
  - [ ] Flutter DevToolsの活用
  - [ ] パフォーマンスプロファイリング
  - [ ] メモリプロファイリング
  - [ ] ネットワークインスペクション（将来的に）

- [ ] クラッシュレポート
  - [ ] Crashlyticsの導入検討
  - [ ] エラートラッキング
  - [ ] ユーザーフィードバック機能

**優先度**: 中（本番リリース前に推奨）

### 16. 追加機能（検討中）

#### カテゴリ機能
- [ ] アイテムのカテゴリ分け機能
  - [ ] カテゴリモデルの作成
  - [ ] カテゴリ別表示
  - [ ] カテゴリフィルター
  - [ ] カテゴリごとの色分け

**優先度**: 中

#### データ管理
- [ ] データのバックアップ/リストア機能
  - [ ] JSON エクスポート
  - [ ] JSON インポート
  - [ ] iCloud 同期（検討中）

**優先度**: 低

#### 通知機能
- [ ] アイテムごとの通知機能
  - [ ] 閾値設定（残数が少なくなった時）
  - [ ] プッシュ通知
  - [ ] 通知設定画面

**優先度**: 低

#### 履歴機能
- [ ] カウント変更履歴
  - [ ] 履歴データモデル
  - [ ] 履歴表示画面
  - [ ] 統計情報（グラフ表示）

**優先度**: 低

#### ソート・検索
- [ ] アイテムのソート機能
  - [ ] 名前順
  - [ ] 作成日時順
  - [ ] 更新日時順
  - [ ] カウント数順

- [ ] アイテムの検索機能
  - [ ] 名前で検索
  - [ ] インクリメンタルサーチ

**優先度**: 中

---

## 🐛 既知の問題

現在、既知の重大な問題はありません。

---

## 📝 開発メモ

### 最近の変更
- 2026-01-04: .cursorrulesに基づくリファクタリング完了
  - 機能ベースのディレクトリ構造に再構成
  - 共通ウィジェット（ErrorView, LoadingView, EmptyStateView）の作成
  - 定数の集約（AppConstants, AppStrings）
  - 巨大なウィジェットの分解
  - Itemモデルの不変化（copyWithメソッド追加）
  - すべてのテスト（41個）が正常にパス
- 2026-01-04: CardTheme → CardThemeData に修正（CI エラー解消）
- 2026-01-04: `use_build_context_synchronously` 警告を解消
- 2026-01-04: `updateItem()` の戻り値チェックを実装
- 2026-01-04: 非同期初期化のエラーハンドリングを強化
- 2026-01-04: 不要なプラットフォームディレクトリを削除（web, windows, linux）

### 技術的負債
- 状態管理: 現在はsetStateベース。アプリが複雑化する前にProvider/Riverpodの導入を推奨
- ナビゲーション: MaterialPageRouteを使用。型安全なgo_routerへの移行を検討
- テストカバレッジ: 単体テストとウィジェットテストは充実。統合テストとE2Eテストの追加を推奨

### 次のマイルストーン
1. **v1.0.0**: 基本機能の完成 ✅ **完了**
   - アイテム管理、データ永続化、UI実装、テスト
   - .cursorrulesに基づくリファクタリング完了

2. **v1.1.0**: アーキテクチャ改善（推奨）
   - 状態管理の導入（Provider/Riverpod）
   - 型安全なナビゲーション（go_router）
   - CI/CD環境の構築

3. **v1.2.0**: iOSウィジェット機能の追加
   - WidgetKitの導入と実装

4. **v1.3.0**: 機能拡張
   - カテゴリ機能とソート機能
   - パフォーマンス最適化

5. **v2.0.0**: 高度な機能
   - 通知機能と履歴機能
   - 国際化対応

---

## 📚 参考資料

- [Flutter公式ドキュメント](https://flutter.dev/docs)
- [WidgetKit チュートリアル](https://developer.apple.com/documentation/widgetkit)
- [shared_preferences パッケージ](https://pub.dev/packages/shared_preferences)
- [Flutter テストガイド](https://flutter.dev/docs/testing)

---

## 🎯 現在の開発フォーカス

**Phase 1: 基本機能の完成** ✅ 完了
- アイテム管理、データ永続化、UI実装、テスト
- .cursorrulesに基づくリファクタリング

**Phase 2: アーキテクチャ改善** 🎯 推奨される次のステップ
- 状態管理の導入（Provider/Riverpod）
- 型安全なナビゲーション（go_router）
- CI/CD環境の構築
- テストカバレッジの拡充

**Phase 3: iOSウィジェット機能** 🚧 主要機能
- WidgetKit の導入と実装

**Phase 4: 機能拡張** 📅 将来的に
- カテゴリ、通知、履歴、検索など
- 国際化対応

## 📊 .cursorrulesに基づく推奨事項の優先度まとめ

### 高優先度（v1.1.0で対応推奨）
1. 状態管理の導入（Provider/Riverpod）
2. CI/CD環境の構築
3. パフォーマンスプロファイリングの実施

### 中優先度（v1.2.0-1.3.0で対応）
1. 型安全なナビゲーション（go_router）
2. テストカバレッジの拡充（統合テスト、E2E）
3. エラーハンドリングの強化
4. デバッグ・モニタリング機能

### 低優先度（v2.0.0以降で対応）
1. セキュリティ対策の強化
2. 国際化対応
3. アクセシビリティの向上
