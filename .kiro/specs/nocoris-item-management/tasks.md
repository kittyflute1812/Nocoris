# 実装計画: Nocorisアイテム管理機能

## 概要

承認された要件定義書と設計書に基づき、Nocorisアプリのアイテム管理機能を実装します。既存のFlutter + Riverpodアーキテクチャを活用し、12の正確性プロパティを検証するテストと共に実装を進めます。

## 実装状況サマリー

### ✅ 完了済み機能（v1.0.0 - v1.1.0）
- **基本アイテム管理**: CRUD操作（作成・読取・更新・削除）
- **カウント機能**: インクリメント・デクリメント・直接設定
- **状態管理**: Riverpod + ChangeNotifierによる効率的な状態管理
- **データ永続化**: shared_preferencesによるローカル保存
- **絵文字アイコン機能**: emoji_picker_flutterを使用したアイコン選択・表示
- **UI実装**: メイン画面、アイテム作成/編集画面、アイテムカード
- **テーマ**: ライト/ダークモード対応、温かみのあるカラーパレット
- **テスト**: 単体テスト、ウィジェットテスト（49テスト、すべてパス）
- **エラーハンドリング**: 非同期処理のエラー処理、ユーザーフィードバック
- **アーキテクチャ**: 機能ベースのディレクトリ構造、依存性注入

### 🚧 開発中・予定の機能
- **アイテム名編集機能**: 編集画面での名前変更（次のPRで実装予定）
- **プロパティベーステスト**: 12の正確性プロパティの検証
- **iOSウィジェット**: WidgetKitを使用したホーム画面・ロック画面ウィジェット
- **型安全ナビゲーション**: go_routerの導入
- **CI/CD環境**: GitHub Actionsによる自動化パイプライン

## タスク

### Phase 1: 基本機能（完了済み） ✅

**注意**: Phase 1のすべての基本機能は実装済みです。現在のコードベースには49のテストがあり、すべてパスしています。以下は記録として残しています。

- [x] 1. コアデータモデルとサービスの実装 ✅
- [x] 2. ストレージサービスの実装 ✅
- [x] 3. アイテムサービスの実装 ✅
- [x] 4. チェックポイント - コアロジックの検証 ✅
- [x] 5. Riverpodプロバイダーの実装 ✅
- [x] 6. UIコンポーネントの実装 ✅
- [x] 7. フォーム画面の実装 ✅
- [x] 8. メイン画面の実装 ✅
- [x] 9. 統合とワイヤリング ✅
- [x] 10. 最終チェックポイント - 全機能の検証 ✅

### Phase 2: 重要な機能改善（v1.1.1） 🔧

- [ ] 11. アイテム名編集機能の実装
  - [ ] 11.1 ItemService.updateItemメソッドの拡張
    - オプショナルなnameパラメータの追加
    - 後方互換性の保持（既存の呼び出しは影響なし）
    - 名前更新時のupdatedAt自動設定
    - _要件: 4.2_
  
  - [ ] 11.2 ItemFormScreenの名前フィールド有効化
    - 編集モード時の名前フィールドを有効化
    - 名前変更時のバリデーション確認
    - UI/UXの一貫性確保
    - _要件: 4.2_
  
  - [ ] 11.3 名前編集機能のテスト追加
    - ItemServiceの名前更新テスト
    - ItemFormScreenの名前編集ウィジェットテスト
    - エッジケースのテスト（空文字、長すぎる名前など）
    - _要件: 4.2_

- [ ] 12. プロパティベーステストの実装
  - [ ] 12.1 テスト環境の準備
    - fakerパッケージの追加（ランダムデータ生成用）
    - プロパティテスト用のヘルパー関数作成
    - テスト実行設定（最低100回の反復）
    - _設計書: 正確性プロパティ_
  
  - [ ] 12.2 データモデルのプロパティテスト
    - **プロパティ 1: アイテム作成によるリスト拡張**
    - **プロパティ 2: 無効入力の拒否**
    - **プロパティ 3: アイコン設定の一貫性**
    - **プロパティ 4: 数量設定の正確性**
    - _検証対象: 要件 1.1, 1.2, 1.3, 1.4, 8.2_
  
  - [ ] 12.3 ビジネスロジックのプロパティテスト
    - **プロパティ 6: インクリメント操作の正確性**
    - **プロパティ 7: デクリメント操作の正確性**
    - **プロパティ 10: アイテム削除の完全性**
    - _検証対象: 要件 3.1, 3.2, 5.2_
  
  - [ ] 12.4 UI・統合のプロパティテスト
    - **プロパティ 5: アイテム表示の完全性**
    - **プロパティ 8: 編集フォーム情報の一致**
    - **プロパティ 9: アイテム更新の反映**
    - _検証対象: 要件 2.2, 4.1, 4.2, 4.3_
  
  - [ ] 12.5 データ永続化のプロパティテスト
    - **プロパティ 11: データ永続化のラウンドトリップ**
    - **プロパティ 12: エラー処理の堅牢性**
    - _検証対象: 要件 1.6, 3.5, 4.5, 5.4, 6.1, 6.3_

### Phase 3: アーキテクチャ改善（v1.2.0） 🏗️

- [ ] 13. 型安全なナビゲーションの実装
  - [ ] 13.1 go_routerの導入
    - go_routerパッケージの追加
    - ルート定義の集約
    - 型安全なナビゲーション実装
    - _要件: 11_
  
  - [ ] 13.2 ディープリンク対応
    - URL ベースのナビゲーション
    - ナビゲーションガードの実装
    - _要件: 11_

- [ ] 14. CI/CD環境の構築
  - [ ] 14.1 GitHub Actionsの設定
    - 自動テスト実行
    - 自動リンティング/フォーマット
    - 自動ビルド
    - _要件: 19_
  
  - [ ] 14.2 デプロイ自動化
    - TestFlightへの自動デプロイ
    - バージョン管理の自動化
    - _要件: 19_

### Phase 4: iOSウィジェット機能（v1.3.0） �

- [ ] 15. WidgetKit実装
  - [ ] 15.1 Widget Extensionの作成
    - Xcodeでの新規ターゲット追加
    - SwiftUIによるウィジェットUI実装
    - 小・中・大サイズ対応
    - _要件: 10_
  
  - [ ] 15.2 データ共有の実装
    - App Groupsの設定
    - Flutter側でのApp Groups対応ストレージ
    - Timeline Providerの実装
    - _要件: 10_
  
  - [ ] 15.3 インタラクション機能
    - App Intentsによるボタンアクション
    - ウィジェットからの減算機能
    - ロック画面ウィジェット対応（iOS 16+）
    - _要件: 10_

### Phase 5: 機能拡張（v1.4.0） 📈

- [ ] 16. カテゴリ機能
  - [ ] 16.1 カテゴリモデルの実装
    - Categoryデータモデル作成
    - アイテムとカテゴリの関連付け
    - _要件: 12_
  
  - [ ] 16.2 カテゴリUI実装
    - カテゴリ別表示
    - カテゴリフィルター
    - カテゴリごとの色分け
    - _要件: 12_

- [ ] 17. ソート・検索機能
  - [ ] 17.1 ソート機能の実装
    - 名前順、作成日時順、更新日時順、カウント数順
    - ソート設定の永続化
    - _要件: 13_
  
  - [ ] 17.2 検索機能の実装
    - 名前による検索
    - インクリメンタルサーチ
    - _要件: 13_

### Phase 6: 高度な機能（v2.0.0） 🚀

- [ ] 18. 通知機能
  - [ ] 18.1 閾値通知の実装
    - アイテムごとの閾値設定
    - プッシュ通知の実装
    - 通知設定画面
    - _要件: 14_

- [ ] 19. 履歴機能
  - [ ] 19.1 履歴データモデル
    - カウント変更履歴の記録
    - 履歴表示画面
    - _要件: 15_
  
  - [ ] 19.2 統計情報
    - グラフ表示
    - 使用パターン分析
    - _要件: 15_

- [ ] 20. データ管理機能
  - [ ] 20.1 バックアップ/リストア
    - JSONエクスポート
    - JSONインポート
    - _要件: 16_
  
  - [ ] 20.2 iCloud同期（検討中）
    - CloudKitの導入検討
    - デバイス間同期
    - _要件: 16_

### Phase 7: 国際化・アクセシビリティ（v2.1.0） 🌍

- [ ] 21. 多言語対応
  - [ ] 21.1 flutter_localizationの導入
    - 言語リソースファイルの作成
    - 動的言語切り替え機能
    - _要件: 17_
  
  - [ ] 21.2 ローカライゼーション
    - 日付・数値のローカライゼーション
    - 右から左への言語対応
    - _要件: 17_

- [ ] 22. アクセシビリティ向上
  - [ ] 22.1 スクリーンリーダー対応
    - セマンティックラベルの充実
    - 音声ナビゲーション対応
    - _要件: 18_
  
  - [ ] 22.2 ユーザビリティ改善
    - フォントサイズの動的調整
    - コントラスト比の確認
    - キーボードナビゲーション対応
    - _要件: 18_

## 重要な設計決定

### アイテム名編集機能の実装方針

**問題**: 要件4.2（アイテム名編集）と現在の実装の不整合
- 要件4.2ではアイテム名の変更が定義されている
- 現在の実装では編集モード時にアイテム名フィールドが無効化されている（`enabled: !isEditMode`）
- ItemService.updateItemメソッドも名前の更新をサポートしていない

**決定**: アイテム名編集を有効化する（要件削除ではなく実装修正）

**実装計画**:
1. `ItemService.updateItem()`メソッドにオプショナルな`name`パラメータを追加
2. `ItemFormScreen`で編集モード時の名前フィールドを有効化
3. 後方互換性を保持（既存の呼び出しは影響なし）
4. 関連するテストを更新

**次のタスク（Phase 2）で実装予定**:
- [ ] ItemService.updateItemメソッドの拡張
- [ ] ItemFormScreenの名前フィールド有効化
- [ ] 関連テストの更新
- [ ] 後方互換性の確保

## 注意事項

- 各タスクは特定の要件を参照し、トレーサビリティを確保
- プロパティテストは設計書の正確性プロパティを検証
- チェックポイントで段階的な検証を実施
- 既存のアーキテクチャ（Flutter + Riverpod）を活用
- 全12のプロパティを網羅的にテストして品質を保証
- Phase 1は完了済み、Phase 2以降を段階的に実装
- 各Phaseは独立してリリース可能な単位として設計
