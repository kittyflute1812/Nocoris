# 実装計画: Nocorisアイテム管理機能

## 概要

承認された要件定義書と設計書に基づき、Nocorisアプリのアイテム管理機能を実装します。既存のFlutter + Riverpodアーキテクチャを活用し、12の正確性プロパティを検証するテストと共に実装を進めます。

## タスク

- [ ] 1. コアデータモデルとサービスの実装
  - [ ] 1.1 Itemモデルの不変性とビジネスルールの実装
    - copyWith、increment、decrement、setCountメソッドの実装
    - JSON変換メソッド（fromJson、toJson）の実装
    - ファクトリメソッド（create）の実装
    - _要件: 1.1, 1.4, 3.1, 3.2_
  
  - [ ] 1.2 Itemモデルのプロパティテスト
    - **プロパティ 1: アイテム作成によるリスト拡張**
    - **検証対象: 要件 1.1**
  
  - [ ] 1.3 Itemモデルの単体テスト
    - エッジケースとエラー条件のテスト
    - _要件: 1.1, 1.4, 3.1, 3.2_

- [ ] 2. ストレージサービスの実装
  - [ ] 2.1 StorageServiceの基本機能実装
    - SharedPreferencesの初期化とファクトリメソッド
    - JSON保存・読み込みメソッドの実装
    - アイテム専用メソッド（saveItems、loadItems）の実装
    - _要件: 1.6, 6.1, 6.2_
  
  - [ ] 2.2 ストレージのプロパティテスト
    - **プロパティ 11: データ永続化のラウンドトリップ**
    - **検証対象: 要件 1.6, 3.5, 4.5, 5.4, 6.1**
  
  - [ ] 2.3 ストレージのエラーハンドリングテスト
    - **プロパティ 12: エラー処理の堅牢性**
    - **検証対象: 要件 6.3**

- [ ] 3. アイテムサービスの実装
  - [ ] 3.1 ItemServiceのCRUD操作実装
    - ChangeNotifierを継承したサービスクラス
    - createItem、updateItem、deleteItemメソッドの実装
    - incrementItem、decrementItemメソッドの実装
    - _要件: 1.1, 3.1, 3.2, 4.2, 4.3, 5.2_
  
  - [ ] 3.2 アイテム操作のプロパティテスト
    - **プロパティ 6: インクリメント操作の正確性**
    - **プロパティ 7: デクリメント操作の正確性**
    - **検証対象: 要件 3.1, 3.2**
  
  - [ ] 3.3 アイテム削除のプロパティテスト
    - **プロパティ 10: アイテム削除の完全性**
    - **検証対象: 要件 5.2**
  
  - [ ] 3.3 入力検証のプロパティテスト
    - **プロパティ 2: 無効入力の拒否**
    - **検証対象: 要件 1.3, 4.4**

- [ ] 4. チェックポイント - コアロジックの検証
  - すべてのテストが通ることを確認し、質問があれば尋ねてください。

- [ ] 5. Riverpodプロバイダーの実装
  - [ ] 5.1 状態管理プロバイダーの実装
    - itemServiceInitProvider（FutureProvider）の実装
    - itemServiceProvider（Provider）の実装
    - 非同期初期化とエラーハンドリングの実装
    - _要件: 2.1, 6.2_
  
  - [ ] 5.2 プロバイダーの統合テスト
    - Riverpodプロバイダーの動作確認
    - モックを使用したテスト
    - _要件: 2.1, 6.2_

- [ ] 6. UIコンポーネントの実装
  - [ ] 6.1 ItemCardウィジェットの実装
    - アイテム情報表示（名前、数量、アイコン）
    - インクリメント・デクリメントボタン
    - 編集・削除メニューの実装
    - _要件: 2.2, 3.1, 3.2_
  
  - [ ] 6.2 ItemCard表示のプロパティテスト
    - **プロパティ 5: アイテム表示の完全性**
    - **検証対象: 要件 2.2**
  
  - [ ] 6.3 絵文字ピッカーウィジェットの実装
    - emoji_picker_flutterライブラリの統合
    - 絵文字選択とアイコン設定機能
    - _要件: 8.1, 8.2_
  
  - [ ] 6.4 アイコン設定のプロパティテスト
    - **プロパティ 3: アイコン設定の一貫性**
    - **検証対象: 要件 1.2, 8.2**

- [ ] 7. フォーム画面の実装
  - [ ] 7.1 ItemFormScreenの実装
    - アイテム作成・編集フォーム
    - バリデーション機能（名前必須、数量0以上）
    - 絵文字アイコン選択機能の統合
    - _要件: 1.1, 1.2, 1.3, 1.4, 4.1, 4.2, 4.3, 4.4_
  
  - [ ] 7.2 フォーム機能のプロパティテスト
    - **プロパティ 4: 数量設定の正確性**
    - **プロパティ 8: 編集フォーム情報の一致**
    - **プロパティ 9: アイテム更新の反映**
    - **検証対象: 要件 1.4, 4.1, 4.2, 4.3**

- [ ] 8. メイン画面の実装
  - [ ] 8.1 HomeScreenの実装
    - ConsumerStatefulWidgetとしての実装
    - アイテム一覧表示（ListView.builder）
    - 空状態の表示
    - エラーハンドリングとユーザーフィードバック
    - _要件: 2.1, 2.2, 2.3_
  
  - [ ] 8.2 HomeScreenのウィジェットテスト
    - アイテム一覧表示の確認
    - 空状態表示の確認
    - エラー状態表示の確認
    - _要件: 2.1, 2.2, 2.3_

- [ ] 9. 統合とワイヤリング
  - [ ] 9.1 全コンポーネントの統合
    - アプリ全体の動作確認
    - Riverpodプロバイダーの適切な配置
    - ナビゲーションとデータフローの確認
    - _要件: すべて_
  
  - [ ] 9.2 エンドツーエンド統合テスト
    - アプリ全体のワークフローテスト
    - データ永続化の確認
    - _要件: すべて_

- [ ] 10. 最終チェックポイント - 全機能の検証
  - すべてのテストが通ることを確認し、質問があれば尋ねてください。

## 重要な設計決定

### アイテム名編集機能の実装方針

**問題**: Gemini Code Assistが指摘した要件4.2（アイテム名編集）と実装の不整合
- 要件4.2ではアイテム名の変更が定義されている
- 現在の実装では編集モード時にアイテム名フィールドが無効化されている
- ItemService.updateItemメソッドも名前の更新をサポートしていない

**決定**: アイテム名編集を有効化する（要件削除ではなく実装修正）

**実装計画**:
1. `ItemService.updateItem()`メソッドにオプショナルな`name`パラメータを追加
2. `ItemFormScreen`で編集モード時の名前フィールドを有効化
3. 後方互換性を保持（既存の呼び出しは影響なし）
4. 関連するテストを更新

**次のPRで実装予定**:
- [ ] ItemService.updateItemメソッドの拡張
- [ ] ItemFormScreenの名前フィールド有効化
- [ ] 関連テストの更新
- [ ] 後方互換性の確保

## 注意事項

- 各タスクは特定の要件を参照し、トレーサビリティを確保
- プロパティテストは設計書の正確性プロパティを検証
- チェックポイントで段階的な検証を実施
- 既存のアーキテクチャ（Flutter + Riverpod）を活用
- 全12のプロパティを網羅的にテストして品質を保証
